<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>PDF å·¥å…·é›†æˆ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .spinner-border { width: 2rem; height: 2rem; }
        .upload-area { 
            border: 2px dashed #0d6efd; 
            border-radius: 8px; 
            padding: 2rem; 
            text-align: center; 
            background: #f8f9fa; 
            margin-bottom: 2rem; 
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        .upload-area:hover {
            border-color: #0a58ca;
            background: #e7f3ff;
        }
        .upload-area.dragover {
            border-color: #198754;
            background: #d1e7dd;
            border-style: solid;
        }
        .upload-area.dragover::before {
            content: "ğŸ“ æ¾å¼€é¼ æ ‡ä¸Šä¼ æ–‡ä»¶";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #198754;
            font-weight: bold;
        }
        .file-info {
            margin-top: 1rem;
            padding: 1rem;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            display: none;
        }
        .drag-text {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .card {
            border: none;
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
        .card-header {
            border-bottom: none;
            padding: 1.5rem;
        }
        .card-body {
            padding: 2rem;
        }
        .btn-lg {
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
        }
        .estimate-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        .estimate-time {
            font-size: 1.1rem;
            font-weight: 600;
            color: #0d6efd;
        }
        .processing-info {
            background: #fff3cd;
            border: 1px solid #ffecb5;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">
            <i class="fas fa-file-pdf me-3"></i>
            4DS Warehouse Tools
        </h1>
        <p class="lead text-muted">4DS ONLY</p>
    </div>
    <!-- åŠŸèƒ½ä¸€ï¼šPDF ä»“åº“åˆ†æ‹£ -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-boxes me-2"></i>
                        4DS 915ï¼Œ8090ï¼Œ60ä»“åº“åˆ†å•å·¥å…·
                    </h4>
                    <small class="text-light">è‡ªåŠ¨è¯†åˆ«PDFä¸­çš„ä»“åº“æ ‡ç­¾å¹¶æŒ‰ä»“åº“ç±»å‹åˆ†ç»„</small>
                </div>
                <div class="card-body">
                    <form id="logicForm" method="post" enctype="multipart/form-data" action="/">
                        <div class="upload-area mb-3" id="uploadArea1">
                            <input type="file" name="pdf_file" accept=".pdf" required class="form-control mb-2" id="fileInput1">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-upload me-2"></i>ä¸Šä¼ å¹¶å¤„ç†
                            </button>
                            <div class="drag-text">æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°è¿™é‡Œ</div>
                            <div class="file-info" id="fileInfo1">
                                <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong><span id="fileName1"></span><br>
                                <strong>æ–‡ä»¶å¤§å°ï¼š</strong><span id="fileSize1"></span>
                            </div>
                        </div>
                        
                        <!-- é¢„ä¼°æ—¶é—´æ˜¾ç¤º -->
                        <div class="estimate-info" id="estimateInfo1">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span class="estimate-time" id="estimateTime1">é¢„ä¼°æ—¶é—´ï¼šè®¡ç®—ä¸­...</span>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                é¢„ä¼°æ—¶é—´åŸºäºæ–‡ä»¶å¤§å°å’Œé¡µæ•°ï¼Œå®é™…æ—¶é—´å¯èƒ½æœ‰æ‰€ä¸åŒ
                            </small>
                        </div>
                        
                        <div id="progressArea1" style="display:none;">
                            <div class="processing-info">
                                <div class="p-3">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="fas fa-cog fa-spin text-primary me-2"></i>
                                        <span class="fs-6">æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...</span>
                                    </div>
                                    
                                    <!-- è¿›åº¦æ¡ -->
                                    <div class="progress mb-3" style="height: 8px;">
                                        <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
                                             role="progressbar" 
                                             id="progressBar1"
                                             style="width: 0%"
                                             aria-valuenow="0" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <span id="processStatus1">æ­£åœ¨åˆ†æPDFç»“æ„...</span>
                                        </small>
                                        <small class="text-muted">
                                            <span id="progressPercent1">0%</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    {% if output_files %}
                        <div class="alert alert-success" id="warehouseResults">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="alert-heading mb-0">
                                    <i class="fas fa-check-circle me-2"></i>å¤„ç†ç»“æœï¼š
                                </h5>
                                <button class="btn btn-sm btn-outline-secondary clear-results-btn" data-target="warehouse">
                                    <i class="fas fa-refresh me-1"></i>æ¸…ç†å¹¶å¼€å§‹æ–°å¤„ç†
                                </button>
                            </div>
                            <ul class="mb-3">
                            {% for file in output_files %}
                                <li class="mb-2 d-flex align-items-center justify-content-between">
                                    <div>
                                        <a href="{{ url_for('download_file', filename=file) }}" class="link-primary text-decoration-none" target="_blank" download>
                                            <i class="fas fa-download me-2"></i>{{ file.split('/')[-1] if '/' in file else file }}
                                        </a>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary rename-btn" data-filename="{{ file.split('/')[-1] if '/' in file else file }}" data-type="warehouse">
                                        <i class="fas fa-edit me-1"></i>é‡å‘½å
                                    </button>
                                </li>
                            {% endfor %}
                            </ul>
                            
                            <!-- é‡å‘½åè¾“å…¥æ¡† -->
                            <div class="rename-section" id="renameSection1" style="display: none;">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-edit me-2"></i>é‡å‘½åæ–‡ä»¶
                                        </h6>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="newFileName1" placeholder="è¾“å…¥æ–°çš„æ–‡ä»¶åï¼ˆä¸éœ€è¦.pdfåç¼€ï¼‰">
                                            <button class="btn btn-primary" id="confirmRename1">
                                                <i class="fas fa-check me-1"></i>ç¡®è®¤
                                            </button>
                                            <button class="btn btn-secondary" id="cancelRename1">
                                                <i class="fas fa-times me-1"></i>å–æ¶ˆ
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">å½“å‰æ–‡ä»¶ï¼š<span id="currentFileName1"></span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½äºŒï¼šæŒ‰é»˜è®¤SKUé¡ºåºé‡ç»„PDF -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-sort-amount-down me-2"></i>
                        ALGINå®¢æˆ·çš„Labelæ’åº
                    </h4>
                    <small class="text-light">ä¸ä¸Šä¼ Excelï¼Œç›´æ¥æŒ‰ç³»ç»Ÿå†…ç½®SKUé¡ºåºé‡ç»„</small>
                </div>
                <div class="card-body">
                    <form id="sortForm" method="post" enctype="multipart/form-data" action="/sort_labels">
                        <div class="upload-area mb-3" id="uploadArea2">
                            <input type="file" name="pdf_file" accept=".pdf" required class="form-control mb-2" id="fileInput2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-sort me-2"></i>ä¸Šä¼ å¹¶é‡ç»„
                            </button>
                            <div class="drag-text">æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°è¿™é‡Œ</div>
                            <div class="file-info" id="fileInfo2">
                                <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong><span id="fileName2"></span><br>
                                <strong>æ–‡ä»¶å¤§å°ï¼š</strong><span id="fileSize2"></span>
                            </div>
                        </div>
                        
                        <!-- é¢„ä¼°æ—¶é—´æ˜¾ç¤º -->
                        <div class="estimate-info" id="estimateInfo2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock me-2 text-success"></i>
                                <span class="estimate-time" id="estimateTime2" style="color: #198754;">é¢„ä¼°æ—¶é—´ï¼šè®¡ç®—ä¸­...</span>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                é¢„ä¼°æ—¶é—´åŸºäºæ–‡ä»¶å¤§å°å’ŒOCRå¤„ç†éœ€æ±‚ï¼Œå®é™…æ—¶é—´å¯èƒ½æœ‰æ‰€ä¸åŒ
                            </small>
                        </div>
                        
                        <div id="progressArea2" style="display:none;">
                            <div class="processing-info">
                                <div class="p-3">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="fas fa-sort fa-spin text-success me-2"></i>
                                        <span class="fs-6">æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...</span>
                                    </div>
                                    
                                    <!-- è¿›åº¦æ¡ -->
                                    <div class="progress mb-3" style="height: 8px;">
                                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                                             role="progressbar" 
                                             id="progressBar2"
                                             style="width: 0%"
                                             aria-valuenow="0" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <span id="processStatus2">æ­£åœ¨ä½¿ç”¨OCRè¯†åˆ«æ ‡ç­¾...</span>
                                        </small>
                                        <small class="text-muted">
                                            <span id="progressPercent2">0%</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    {% if sorted_file %}
                        <div class="alert alert-success" id="alginResults">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="alert-heading mb-0">
                                    <i class="fas fa-check-circle me-2"></i>é‡ç»„ç»“æœï¼š
                                </h5>
                                <button class="btn btn-sm btn-outline-secondary clear-results-btn" data-target="algin">
                                    <i class="fas fa-refresh me-1"></i>æ¸…ç†å¹¶å¼€å§‹æ–°å¤„ç†
                                </button>
                            </div>
                            <div class="mb-3 d-flex align-items-center justify-content-between">
                                <div>
                                    <a href="{{ url_for('download_file', filename=sorted_file) }}" class="link-primary text-decoration-none" target="_blank" download>
                                        <i class="fas fa-download me-2"></i>{{ sorted_file.split('/')[-1] if '/' in sorted_file else sorted_file }}
                                    </a>
                                </div>
                                <button class="btn btn-sm btn-outline-success rename-btn" data-filename="{{ sorted_file.split('/')[-1] if '/' in sorted_file else sorted_file }}" data-type="sorted">
                                    <i class="fas fa-edit me-1"></i>é‡å‘½å
                                </button>
                            </div>
                            
                            <!-- é‡å‘½åè¾“å…¥æ¡† -->
                            <div class="rename-section" id="renameSection2" style="display: none;">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-edit me-2"></i>é‡å‘½åæ–‡ä»¶
                                        </h6>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="newFileName2" placeholder="è¾“å…¥æ–°çš„æ–‡ä»¶åï¼ˆä¸éœ€è¦.pdfåç¼€ï¼‰">
                                            <button class="btn btn-success" id="confirmRename2">
                                                <i class="fas fa-check me-1"></i>ç¡®è®¤
                                            </button>
                                            <button class="btn btn-secondary" id="cancelRename2">
                                                <i class="fas fa-times me-1"></i>å–æ¶ˆ
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">å½“å‰æ–‡ä»¶ï¼š<span id="currentFileName2"></span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <script>
        // æ–‡ä»¶æ‹–æ‹½åŠŸèƒ½
        function setupDragAndDrop(uploadArea, fileInput, fileInfo, fileName, fileSize) {
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸæ—¶è§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadArea.addEventListener('click', function(e) {
                if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                    fileInput.click();
                }
            });

            // é˜²æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // æ‹–æ‹½æ—¶çš„è§†è§‰åé¦ˆ
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadArea.classList.add('dragover');
            }

            function unhighlight(e) {
                uploadArea.classList.remove('dragover');
            }

            // å¤„ç†æ–‡ä»¶æ”¾ç½®
            uploadArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'application/pdf') {
                        // å°†æ–‡ä»¶èµ‹å€¼ç»™input
                        fileInput.files = files;
                        showFileInfo(file, fileInfo, fileName, fileSize);
                        
                        // æ˜¾ç¤ºé¢„ä¼°æ—¶é—´
                        const uploadAreaId = uploadArea.id;
                        const isFunction2 = uploadAreaId.includes('2');
                        const estimateElement = document.getElementById(`estimateInfo${isFunction2 ? '2' : '1'}`);
                        const timeElement = document.getElementById(`estimateTime${isFunction2 ? '2' : '1'}`);
                        showEstimateTime(file, estimateElement, timeElement, isFunction2);
                    } else {
                        alert('è¯·é€‰æ‹©PDFæ–‡ä»¶');
                    }
                }
            }

            // æ–‡ä»¶è¾“å…¥æ¡†å˜åŒ–æ—¶æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    showFileInfo(file, fileInfo, fileName, fileSize);
                    
                    // æ˜¾ç¤ºé¢„ä¼°æ—¶é—´
                    const uploadAreaId = uploadArea.id;
                    const isFunction2 = uploadAreaId.includes('2');
                    const estimateElement = document.getElementById(`estimateInfo${isFunction2 ? '2' : '1'}`);
                    const timeElement = document.getElementById(`estimateTime${isFunction2 ? '2' : '1'}`);
                    showEstimateTime(file, estimateElement, timeElement, isFunction2);
                }
            });
        }

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        function showFileInfo(file, fileInfo, fileName, fileSize) {
            const size = (file.size / 1024 / 1024).toFixed(2);
            fileName.textContent = file.name;
            fileSize.textContent = size + ' MB';
            fileInfo.style.display = 'block';
        }

        // è®¡ç®—é¢„ä¼°æ—¶é—´
        function calculateEstimateTime(file, isFunction2 = false) {
            const sizeInMB = file.size / 1024 / 1024;
            let estimateSeconds;
            
            if (isFunction2) {
                // åŠŸèƒ½äºŒï¼šéœ€è¦OCRå¤„ç†ï¼Œæ—¶é—´æ›´é•¿
                // åŸºäºç»éªŒï¼šæ¯MBçº¦éœ€è¦8-12ç§’ï¼ˆåŒ…å«OCRï¼‰
                estimateSeconds = Math.ceil(sizeInMB * 10) + 5; // åŸºç¡€æ—¶é—´ + 5ç§’åˆå§‹åŒ–
            } else {
                // åŠŸèƒ½ä¸€ï¼šä»“åº“åˆ†æ‹£ï¼Œä¸»è¦æ˜¯æ–‡æœ¬å¤„ç†
                // åŸºäºç»éªŒï¼šæ¯MBçº¦éœ€è¦3-5ç§’
                estimateSeconds = Math.ceil(sizeInMB * 4) + 2; // åŸºç¡€æ—¶é—´ + 2ç§’åˆå§‹åŒ–
            }
            
            // ç¡®ä¿æœ€å°æ—¶é—´
            estimateSeconds = Math.max(estimateSeconds, 5);
            
            // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
            if (estimateSeconds < 60) {
                return `${estimateSeconds} ç§’`;
            } else {
                const minutes = Math.floor(estimateSeconds / 60);
                const seconds = estimateSeconds % 60;
                return `${minutes} åˆ† ${seconds} ç§’`;
            }
        }

        // æ˜¾ç¤ºé¢„ä¼°æ—¶é—´
        function showEstimateTime(file, estimateElement, timeElement, isFunction2 = false) {
            const estimateTime = calculateEstimateTime(file, isFunction2);
            timeElement.textContent = `é¢„ä¼°æ—¶é—´ï¼š${estimateTime}`;
            estimateElement.style.display = 'block';
        }

        // ä¸ºä¸¤ä¸ªåŠŸèƒ½è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
        setupDragAndDrop(
            document.getElementById('uploadArea1'),
            document.getElementById('fileInput1'),
            document.getElementById('fileInfo1'),
            document.getElementById('fileName1'),
            document.getElementById('fileSize1')
        );

        setupDragAndDrop(
            document.getElementById('uploadArea2'),
            document.getElementById('fileInput2'),
            document.getElementById('fileInfo2'),
            document.getElementById('fileName2'),
            document.getElementById('fileSize2')
        );

        // ä¼˜åŒ–çš„é‡å‘½ååŠŸèƒ½
        function setupRenameFeature() {
            let currentRenamingFile = null;
            let currentRenameType = null;
            
            // é˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶
            if (window.renameEventsBound) {
                return;
            }
            window.renameEventsBound = true;
            
            // ç¼“å­˜DOMå…ƒç´ 
            const sections = {
                1: document.getElementById('renameSection1'),
                2: document.getElementById('renameSection2')
            };
            const inputs = {
                1: document.getElementById('newFileName1'),
                2: document.getElementById('newFileName2')
            };
            const fileSpans = {
                1: document.getElementById('currentFileName1'),
                2: document.getElementById('currentFileName2')
            };
            
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä½†é™åˆ¶æŸ¥è¯¢èŒƒå›´
            document.addEventListener('click', function(e) {
                const target = e.target;
                
                // å¤„ç†é‡å‘½åæŒ‰é’®ç‚¹å‡»
                if (target.classList.contains('rename-btn')) {
                    e.preventDefault();
                    handleRenameClick(target);
                    return;
                }
                
                // å¤„ç†ç¡®è®¤å’Œå–æ¶ˆæŒ‰é’®
                const buttonId = target.id;
                if (buttonId.startsWith('confirmRename')) {
                    e.preventDefault();
                    const sectionNum = parseInt(buttonId.slice(-1));
                    confirmRename(sectionNum);
                } else if (buttonId.startsWith('cancelRename')) {
                    e.preventDefault();
                    const sectionNum = parseInt(buttonId.slice(-1));
                    cancelRename(sectionNum);
                }
            });
            
            function handleRenameClick(button) {
                const filename = button.dataset.filename;
                const type = button.dataset.type;
                
                currentRenamingFile = filename;
                currentRenameType = type;
                
                const sectionNum = type === 'warehouse' ? 1 : 2;
                const section = sections[sectionNum];
                const input = inputs[sectionNum];
                const fileSpan = fileSpans[sectionNum];
                
                if (section && input && fileSpan) {
                    // æ‰¹é‡DOMæ“ä½œ
                    requestAnimationFrame(() => {
                        section.style.display = 'block';
                        fileSpan.textContent = filename;
                        input.value = filename.replace('.pdf', '');
                        input.focus();
                        input.select();
                        
                        // éšè—å½“å‰æŒ‰é’®å³å¯
                        button.style.display = 'none';
                    });
                }
            }
            
            // ä¼˜åŒ–çš„ç¡®è®¤é‡å‘½åå‡½æ•°
            function confirmRename(sectionNum) {
                const input = inputs[sectionNum];
                const newName = input.value.trim();
                
                if (!newName) {
                    input.focus();
                    return;
                }
                
                // å¿«é€Ÿæ–‡ä»¶åéªŒè¯
                if (/[\/\\:*?"<>|]/.test(newName)) {
                    showToast('æ–‡ä»¶åä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼š/ \\ : * ? " < > |', 'error');
                    input.focus();
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶åé•¿åº¦
                if (newName.length > 200) {
                    showToast('æ–‡ä»¶åè¿‡é•¿ï¼Œè¯·ä½¿ç”¨è¾ƒçŸ­çš„åç§°', 'error');
                    input.focus();
                    return;
                }
                
                const confirmBtn = document.getElementById(`confirmRename${sectionNum}`);
                const originalText = confirmBtn.innerHTML;
                
                // ç«‹å³ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>å¤„ç†ä¸­...';
                
                // ä½¿ç”¨fetchå‘é€è¯·æ±‚ï¼Œä¸é˜»å¡UI
                fetch('/rename_file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        old_filename: currentRenamingFile,
                        new_filename: newName + '.pdf'
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error('ç½‘ç»œé”™è¯¯');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // ä½¿ç”¨åç«¯è¿”å›çš„å‡†ç¡®è·¯å¾„ä¿¡æ¯æ›´æ–°DOM
                        updateFileNameInDOMWithPath(currentRenamingFile, data.new_filename, data.new_path);
                        cancelRename(sectionNum);
                        showToast('é‡å‘½åæˆåŠŸï¼', 'success');
                    } else {
                        throw new Error(data.error || 'é‡å‘½åå¤±è´¥');
                    }
                })
                .catch(error => {
                    console.error('é‡å‘½åé”™è¯¯:', error);
                    showToast('é‡å‘½åå¤±è´¥ï¼š' + error.message, 'error');
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                });
            }
            
            // ä¼˜åŒ–çš„å–æ¶ˆé‡å‘½åå‡½æ•°
            function cancelRename(sectionNum) {
                const section = sections[sectionNum];
                if (section) {
                    section.style.display = 'none';
                }
                
                // æ¢å¤é‡å‘½åæŒ‰é’®æ˜¾ç¤º - ä½¿ç”¨å½“å‰æ–‡ä»¶åæŸ¥æ‰¾æŒ‰é’®
                if (currentRenamingFile) {
                    const renameBtn = document.querySelector(`.rename-btn[data-filename="${currentRenamingFile}"]`);
                    if (renameBtn) {
                        renameBtn.style.display = 'inline-block';
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰å½“å‰æ–‡ä»¶åï¼ŒæŒ‰ç±»å‹æŸ¥æ‰¾
                    const targetType = sectionNum === 1 ? 'warehouse' : 'sorted';
                    const targetBtn = document.querySelector(`.rename-btn[data-type="${targetType}"]`);
                    if (targetBtn) {
                        targetBtn.style.display = 'inline-block';
                    }
                }
                
                // é‡ç½®çŠ¶æ€ä½†ä¸æ¸…ç©ºcurrentRenamingFileï¼Œä¿æŒå¯é‡å‘½åçŠ¶æ€
                currentRenameType = null;
            }
            
            // ä½¿ç”¨åç«¯è¿”å›çš„è·¯å¾„ä¿¡æ¯æ›´æ–°DOM
            function updateFileNameInDOMWithPath(oldName, newName, newPath) {
                console.log('Updating file name from:', oldName, 'to:', newName, 'with path:', newPath);
                
                // æ›´æ–°ä¸‹è½½é“¾æ¥ - ä½¿ç”¨ç²¾ç¡®çš„æ–‡ä»¶ååŒ¹é…
                const links = document.querySelectorAll('a');
                links.forEach(link => {
                    // æ£€æŸ¥é“¾æ¥æ–‡æœ¬æˆ–hrefæ˜¯å¦åŒ…å«æ—§æ–‡ä»¶å
                    const linkText = link.textContent.trim();
                    const isTargetLink = linkText.includes(oldName) || link.href.includes(encodeURIComponent(oldName));
                    
                    if (isTargetLink) {
                        // æ›´æ–°ä¸‹è½½é“¾æ¥åˆ°æ–°è·¯å¾„
                        const baseUrl = window.location.origin;
                        link.href = `${baseUrl}/download/${encodeURIComponent(newPath)}`;
                        
                        // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                        const icon = link.querySelector('i');
                        const iconHTML = icon ? icon.outerHTML : '';
                        link.innerHTML = iconHTML + newName;
                        
                        console.log('Updated link href to:', link.href);
                    }
                });
                
                // æŸ¥æ‰¾å¹¶æ›´æ–°é‡å‘½åæŒ‰é’® - ä½¿ç”¨æ›´çµæ´»çš„é€‰æ‹©å™¨
                let renameBtn = document.querySelector(`.rename-btn[data-filename="${oldName}"]`);
                
                // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾éšè—çš„æŒ‰é’®
                if (!renameBtn) {
                    const allRenameButtons = document.querySelectorAll('.rename-btn');
                    for (let btn of allRenameButtons) {
                        if (btn.getAttribute('data-filename') === oldName || btn.style.display === 'none') {
                            renameBtn = btn;
                            break;
                        }
                    }
                }
                
                if (renameBtn) {
                    renameBtn.setAttribute('data-filename', newName);
                    renameBtn.style.display = 'inline-block';
                    console.log('Updated rename button data-filename to:', newName);
                } else {
                    console.warn('Rename button not found for:', oldName);
                }
                
                // æ›´æ–°å…¨å±€å˜é‡ä»¥ä¾¿ä¸‹æ¬¡é‡å‘½å
                currentRenamingFile = newName;
            }
            
            // ä¿ç•™æ—§å‡½æ•°ä½œä¸ºåå¤‡
            function updateFileNameInDOM(oldName, newName) {
                updateFileNameInDOMWithPath(oldName, newName, newName);
            }
            
            // è½»é‡çº§æç¤ºæ¶ˆæ¯
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `alert alert-${type === 'error' ? 'danger' : 'success'} position-fixed`;
                toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
                toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} me-2"></i>${message}`;
                
                document.body.appendChild(toast);
                
                // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 3000);
            }
            
            // æ”¯æŒå›è½¦é”®ç¡®è®¤é‡å‘½å
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.id.startsWith('newFileName')) {
                    const sectionNum = parseInt(e.target.id.slice(-1));
                    confirmRename(sectionNum);
                } else if (e.key === 'Escape') {
                    // ESCé”®å–æ¶ˆé‡å‘½å
                    if (currentRenamingFile) {
                        const sectionNum = currentRenameType === 'warehouse' ? 1 : 2;
                        cancelRename(sectionNum);
                    }
                }
            });
        }

        // åˆå§‹åŒ–é‡å‘½ååŠŸèƒ½
        setupRenameFeature();

        // æ›´æ–°å¤„ç†çŠ¶æ€å’Œè¿›åº¦æ¡
        function updateProcessStatus(statusElement, messages, progressBarId, progressPercentId, interval = 2000) {
            let currentIndex = 0;
            const progressBar = document.getElementById(progressBarId);
            const progressPercent = document.getElementById(progressPercentId);
            
            const statusInterval = setInterval(() => {
                if (currentIndex < messages.length) {
                    // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                    statusElement.textContent = messages[currentIndex];
                    
                    // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
                    const progressValue = Math.round(((currentIndex + 1) / messages.length) * 100);
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    progressBar.style.width = progressValue + '%';
                    progressBar.setAttribute('aria-valuenow', progressValue);
                    progressPercent.textContent = progressValue + '%';
                    
                    currentIndex++;
                } else {
                    // å¤„ç†å®Œæˆï¼Œè®¾ç½®ä¸º100%
                    progressBar.style.width = '100%';
                    progressBar.setAttribute('aria-valuenow', 100);
                    progressPercent.textContent = '100%';
                    clearInterval(statusInterval);
                }
            }, interval);
            return statusInterval;
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('logicForm').addEventListener('submit', function(e) {
            const fileInput = document.getElementById('fileInput1');
            if (!fileInput.files.length) {
                e.preventDefault();
                alert('è¯·é€‰æ‹©PDFæ–‡ä»¶');
                return;
            }
            
            // æ˜¾ç¤ºå¤„ç†è¿›åº¦
            document.getElementById('progressArea1').style.display = 'block';
            
            // é‡ç½®è¿›åº¦æ¡
            const progressBar1 = document.getElementById('progressBar1');
            const progressPercent1 = document.getElementById('progressPercent1');
            progressBar1.style.width = '0%';
            progressBar1.setAttribute('aria-valuenow', 0);
            progressPercent1.textContent = '0%';
            
            // æ›´æ–°å¤„ç†çŠ¶æ€å’Œè¿›åº¦æ¡
            const statusElement = document.getElementById('processStatus1');
            const messages = [
                'æ­£åœ¨åˆ†æPDFç»“æ„...',
                'æ­£åœ¨æå–ä»“åº“æ ‡ç­¾...',
                'æ­£åœ¨æŒ‰ç±»å‹åˆ†ç»„...',
                'æ­£åœ¨ç”Ÿæˆè¾“å‡ºæ–‡ä»¶...',
                'å³å°†å®Œæˆå¤„ç†...'
            ];
            updateProcessStatus(statusElement, messages, 'progressBar1', 'progressPercent1', 1500);
        });

        document.getElementById('sortForm').addEventListener('submit', function(e) {
            const fileInput = document.getElementById('fileInput2');
            if (!fileInput.files.length) {
                e.preventDefault();
                alert('è¯·é€‰æ‹©PDFæ–‡ä»¶');
                return;
            }
            
            // æ˜¾ç¤ºå¤„ç†è¿›åº¦
            document.getElementById('progressArea2').style.display = 'block';
            
            // é‡ç½®è¿›åº¦æ¡
            const progressBar2 = document.getElementById('progressBar2');
            const progressPercent2 = document.getElementById('progressPercent2');
            progressBar2.style.width = '0%';
            progressBar2.setAttribute('aria-valuenow', 0);
            progressPercent2.textContent = '0%';
            
            // æ›´æ–°å¤„ç†çŠ¶æ€å’Œè¿›åº¦æ¡
            const statusElement = document.getElementById('processStatus2');
            const messages = [
                'æ­£åœ¨ä½¿ç”¨OCRè¯†åˆ«æ ‡ç­¾...',
                'æ­£åœ¨æå–SKUä¿¡æ¯...',
                'æ­£åœ¨æŸ¥æ‰¾åŒ¹é…çš„SKU...',
                'æ­£åœ¨æŒ‰é¡ºåºé‡æ–°æ’åˆ—...',
                'æ­£åœ¨ç”Ÿæˆæ’åºåçš„PDF...',
                'å³å°†å®Œæˆå¤„ç†...'
            ];
            updateProcessStatus(statusElement, messages, 'progressBar2', 'progressPercent2', 1800);
        });

        // æ¸…é™¤ç»“æœåŠŸèƒ½
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('clear-results-btn') || e.target.closest('.clear-results-btn')) {
                e.preventDefault();
                const btn = e.target.classList.contains('clear-results-btn') ? e.target : e.target.closest('.clear-results-btn');
                const target = btn.dataset.target;
                
                // ç¡®è®¤æ¸…é™¤
                if (confirm('ç¡®å®šè¦æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¹¶å¼€å§‹æ–°çš„å¤„ç†å—ï¼Ÿ\næ³¨æ„ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰æœªä¸‹è½½çš„å¤„ç†ç»“æœæ–‡ä»¶ã€‚')) {
                    // è°ƒç”¨åç«¯æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                    fetch('/clear_temp_files', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // éšè—å¯¹åº”çš„ç»“æœåŒºåŸŸ
                            if (target === 'warehouse') {
                                const warehouseResults = document.getElementById('warehouseResults');
                                if (warehouseResults) {
                                    warehouseResults.style.display = 'none';
                                }
                            } else if (target === 'algin') {
                                const alginResults = document.getElementById('alginResults');
                                if (alginResults) {
                                    alginResults.style.display = 'none';
                                }
                            }
                            
                            showToast('ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†ï¼Œå¯ä»¥å¼€å§‹æ–°çš„å¤„ç†', 'success');
                        } else {
                            showToast('æ¸…ç†å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('æ¸…ç†é”™è¯¯:', error);
                        showToast('æ¸…ç†å¤±è´¥ï¼š' + error.message, 'error');
                    });
                }
            }
        });

        // æ”¹è¿›é‡å‘½åæŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘
        function ensureRenameButtonsVisible() {
            // ç¡®ä¿æ‰€æœ‰é‡å‘½åæŒ‰é’®éƒ½å¯è§
            document.querySelectorAll('.rename-btn').forEach(btn => {
                if (btn.style.display === 'none') {
                    btn.style.display = 'inline-block';
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåç¡®ä¿é‡å‘½åæŒ‰é’®å¯è§
        document.addEventListener('DOMContentLoaded', function() {
            ensureRenameButtonsVisible();
        });
    </script>
</body>
</html> 